name: Python CI â€“ AIâ€‘Recruitmentâ€‘Suite

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ðŸ‘‰ All repository secrets become env vars for every step below
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    env:
      WO_DEVELOPER_EDITION_SOURCE:      ${{ secrets.WO_DEVELOPER_EDITION_SOURCE }}
      WO_ENTITLEMENT_KEY:               ${{ secrets.WO_ENTITLEMENT_KEY }}
      WATSONX_APIKEY:                   ${{ secrets.WATSONX_APIKEY }}
      WATSONX_SPACE_ID:                 ${{ secrets.WATSONX_SPACE_ID }}
      WO_DEVELOPER_EDITION_SKIP_LOGIN:  ${{ secrets.WO_DEVELOPER_EDITION_SKIP_LOGIN }}

    steps:
      # 1. Check out repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Python and cache pip
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      # 3. Install system packages needed for build (gcc, make, etc.)
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential

      # 4. Bootstrap the virtual env & Python deps
      - name: Install Python dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          # base deps
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # agentâ€‘tool deps
          if [ -f tools/requirements.txt ]; then pip install -r tools/requirements.txt; fi

      # 5. Run the full Makefile pipeline
      - name: Run make install âžœ start âžœ run
        run: |
          source .venv/bin/activate
          make install
          make start
          make run

      # 6. OPTIONAL healthâ€‘check / test placeholder
      # - name: run make check      # TODO: create this target later
      #   run: |
      #     source .venv/bin/activate
      #     make check

      # 7. Always attempt a clean shutdown so the runner is tidy
      - name: Stop services
        if: always()
        run: |
          source .venv/bin/activate
          make stop || true
